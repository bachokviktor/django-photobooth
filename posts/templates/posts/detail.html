{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}
  {% translate "Post by" %} {{ post.author.username }}
{% endblock %}

{% block content %}
  {% translate "modified" as t_modified %}
  {% translate "Like" as t_like %}
  {% translate "Unlike" as t_unlike %}
  {% translate "Delete" as t_delete %}
  {% translate "Likes" as t_likes %}

  <div class="row">
    <div class="col-sm-6 mb-4">
      <div id="postPhotoCarousel" class="carousel slide">
	<div class="carousel-inner">
	  {% for p in post.photos.all %}
	    {% if forloop.counter == 1 %}
	      <div class="carousel-item active">
	    {% else %}
              <div class="carousel-item">
	    {% endif %}
	      <img src="{{ p.photo.url }}" class="d-block w-100" alt="Post photo {{ forloop.counter }}">
	    </div>
	  {% endfor %}
        </div>
	<button class="carousel-control-prev" type="button" data-bs-target="#postPhotoCarousel" data-bs-slide="prev">
	  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
	  <span class="visually-hidden">{% translate "Previous" %}</span>
	</button>
	<button class="carousel-control-next" type="button" data-bs-target="#postPhotoCarousel" data-bs-slide="next">
	  <span class="carousel-control-next-icon" aria-hidden="true"></span>
	  <span class="visually-hidden">{% translate "Next" %}</span>
	</button>
      </div>
    </div>
    <div class="col-sm-6 mb-4">
      <p><a href="{% url 'users:profile' username=post.author.username %}">{{ post.author.username }}</a>: {{ post.description }}</p>
    
      {% if post.modified_at %}
	<p>{{ post.modified_at }} ({{ t_modified }})</p>
      {% else %}
	<p>{{ post.created_at }}</p>
      {% endif %}

      <p>{{ t_likes }}: {{ post.likes.all.count }} | {% translate "Saves" %}: {{ post.saves.all.count }}</p>

      {% if user.is_authenticated %}
	<div class="row">
	  <div class="col-md-auto">
	    {% if user in post.likes.all %}
	      <form action="{% url 'posts:unlike' pk=post.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_unlike }}</button>
	      </form>
	    {% else %}
	      <form action="{% url 'posts:like' pk=post.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_like }}</button>
	      </form>
	    {% endif %}
	  </div>

	  <div class="col-md-auto">
	    {% if user in post.saves.all %}
	      <form action="{% url 'posts:unsave' pk=post.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-warning" type="submit">{% translate "Unsave" %}</button>
	      </form>
	    {% else %}
	      <form action="{% url 'posts:save' pk=post.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-warning" type="submit">{% translate "Save" %}</button>
	      </form>
	    {% endif %}
	  </div>

	  {% if user == post.author %}
	    <div class="col-md-auto">
	      <a href="{% url 'posts:edit' pk=post.id %}" class="btn btn-primary">{% translate "Edit" %}</a>
	    </div>

	    <div class="col">
	      <form action="{% url 'posts:delete' pk=post.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_delete }}</button>
	      </form>
	    </div>
	  {% endif %}
	</div>
      {% endif %}
    </div>
  </div>

  <div class="mt-4">
    <h2>{% translate "Comments" %}</h2>
    {% if post.comments.all %}
      {% for comment in post.comments.all %}
	<div>
	  <p><a href="{% url 'users:profile' username=comment.author.username %}">{{ comment.author.username }}</a>: {{ comment.text }}</p>
	  {% if comment.modified_at %}
	    <p>{{ comment.modified_at }} ({{ t_modified }})</p>
	  {% else %}
	    <p>{{ comment.created_at }}</p>
	  {% endif %}
	  <p>{{ t_likes }}: {{ comment.likes.all.count }}</p>
	  {% if user.is_authenticated %}
	    {% if user in comment.likes.all %}
	      <form action="{% url 'posts:unlike_comment' pk=post.id comment_id=comment.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_unlike }}</button>
	      </form>
	    {% else %}
	      <form action="{% url 'posts:like_comment' pk=post.id comment_id=comment.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_like }}</button>
	      </form>
	    {% endif %}

	    {% if user == comment.author %}
	      <form action="{% url 'posts:delete_comment' pk=post.id comment_id=comment.id %}" method="post">
		{% csrf_token %}
		<button class="btn btn-danger" type="submit">{{ t_delete }}</button>
	      </form>
	    {% endif %}
	  {% endif %}
	</div>
      {% endfor %}
    {% else %}
      <p>{% translate "No comments." %}</p>
    {% endif %}

    {% if user.is_authenticated %}
      <div>
	<form action="{% url 'posts:comment' pk=post.id %}" method="post">
	  {% csrf_token %}
	  {{ comment_form|crispy }}

          <button class="btn btn-primary" type="submit">{% translate "Comment" %}</button>
	</form>
      </div>
    {% endif %}
  </div>  
{% endblock %}
